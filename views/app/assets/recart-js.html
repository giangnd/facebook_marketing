'use strict';

var recartCss = ".recart-modal{position:fixed;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);opacity:0;visibility:hidden;transform:scale(1.1);transition:visibility 0s linear .25s,opacity .25s 0s,transform .25s}.recart-modal-content{text-align:center;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#4267B2;color:#fff;padding:1rem 1.5rem;width:600px;height:600px;border-radius:50%}.recart-modal-content p{color:#fff}.recart-modal-content button{font-size:16px;color:#FFF;font-weight:700;padding:7px 20px;-webkit-border-radius:2px;-moz-border-radius:2px;border-radius:2px;background-color:#fbb040;border:none}.recart-close-button{position:absolute;right:0;width:1.5rem;line-height:1.5rem;text-align:center;cursor:pointer;border-radius:.25rem;font-size:30px}.recart-show-modal{opacity:1;visibility:visible;transform:scale(1);transition:visibility 0s linear 0s,opacity .25s 0s,transform .25s;animation-name:fadeInOpacity;animation-iteration-count:1;animation-timing-function:ease-in;animation-duration:0.5s}@keyframes fadeInOpacity{0%{opacity:0}100%{opacity:1}}";
inlineCss(recartCss);

function inlineCss(recartCss) {
    var customStyle = document.createElement('style');
    customStyle.innerHTML = recartCss;
    document.head.appendChild(customStyle);
}

function popUpForm() {
    var html = '<div class="recart-modal">';
    html += '<div class="recart-modal-content">';
    html += '<span class="recart-close-button" onclick="recartClickClose()">&times;</span>';
    html += '<p class="p1" style="text-transform: uppercase;font-size: 28px;margin-bottom: 15px;margin-top:100px">Because You Are Special!</p>';
    html += '<div class="hide_on_submit">';
    html += '<p class="p2" style="text-transform: uppercase;font-size: 50px;line-height: 50px;font-weight: 700;margin-bottom: 20px">15% Discount</p>';
    html += '<p class="p3" style="text-transform: uppercase;font-size: 20px;font-weight: bold;margin-bottom: 15px">On Your First Buy</p>';
    html += '<p class="p4" style="margin-bottom:10px">Let`s activate your discount code</p>';
    html += '<p class="p5" style="font-weight: 700;">Now!</p>';
    html += '<div class="fbm_checkbox_content"></div>';
    html += '<button type="button" class="fbm_submit_button" onclick="recartPopupSubmit()">';
    html += 'Inbox My Discount Code Now';
    html += '</button>';
    html += '<p style="font-size:12px;cursor:pointer;text-decoration:underline;margin-top:20px;" onclick="recartClickClose()">No thanks. I`d rather pay full price.</p>';
    html += '</div>';
    html += '<div class="recart-popup-message"></div>';
    html += '</div>';
    html += '</div>';

    return html;
}

function recartOpenPopup() {
    document.querySelector('.recart-modal').classList.add('recart-show-modal');
    return false;
}

function recartClosePopup() {
    document.querySelector('.recart-modal').classList.remove('recart-show-modal');
}

function recartClickClose() {
    setCookieAfterClickClose();
    recartClosePopup();
}

function setCookieAfterClickClose() {
    var d = new Date();
    d.setTime(d.getTime() + (24 * 60 * 60 * 1000));
    d.setHours(0)
    d.setMinutes(0);
    d.setSeconds(0);
    _setCookie("___recartClosedPopup", 1, d);
}

function setCookieSubscribed(minutes) {
    //cookie for subscribed
    var d = new Date();
    d.setTime(d.getTime() + (minutes * 60 * 1000));
    _setCookie("___recartClosedPopup", 1, d);
    _setCookie("___recartUserSubscribed", 1, d);
}

function _setCookie(cname, cvalue, exdays) {
    var expires = "expires=" + exdays;
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function _getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

var renderMsgButton = false;
const userRef = uuidv4();
const recartAppId = '{{fbAppId}}';
const recartPageId = '{{fbPageId}}';

$(document).ready(function () {
    $('body').append(popUpForm());

    if (!_getCookie("___recartClosedPopup")) {
        setTimeout(function () {
            recartOpenPopup();
        }, 2000);
    }

    if (!_getCookie("___recartUserSubscribed")) {
        $('.fbm_checkbox_content').html('<div class="fb-messenger-checkbox" origin="' + window.location.origin + '" page_id="' + recartPageId + '" messenger_app_id="' + recartAppId + '" user_ref="' + userRef + '" prechecked="true" allow_login="true" size="small" skin="dark" center_align="true"></div>');
    }
});

window.fbAsyncInit = function () {
    FB.init({
        appId: recartAppId,
        autoLogAppEvents: true,
        xfbml: true,
        version: 'v2.12'
    });

    FB.Event.subscribe('messenger_checkbox', function (e) {
        console.log("messenger_checkbox event");
        console.log(e);

        if (e.event == 'rendered') {
            console.log("Plugin was rendered");
            renderMsgButton = true;
            recartLinkShowPopup();
        } else if (e.event == 'checkbox') {
            console.log("Checkbox state: " + e.state);
        } else if (e.event == 'not_you') {
            console.log("User clicked 'not you'");
        } else if (e.event == 'hidden') {
            console.log("Plugin was hidden");
        }
    });
};

(function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) { return; }
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

function recartLinkShowPopup() {
    if (renderMsgButton) {
        $('nav ul li:last').clone().appendTo('nav ul').find('a').addClass('recartLinkOpenPopup').text('Get 15% discount NOW!').attr({ onclick: 'return recartOpenPopup()', href: '' });
    }
}

function recartRemoveLinkPopup() {
    $('nav ul li a.recartLinkOpenPopup').remove();
}

function recartPopupSubmit() {
    //fb send messenger
    FB.AppEvents.logEvent('MessengerCheckboxUserConfirmation', null, {
        'app_id': recartAppId,
        'page_id': recartPageId,
        'user_ref': userRef
    });

    $(".fbm_submit_button").text("Please Wait...");

    setTimeout(function () {
        recartSendAjax();
    }, 300);
}

function recartSendAjax() {
    var subscribedMessage = "Your discount code has been sent to your FB messenger! Get it and enjoy saving shopping now!";
    //send ajax
    $.ajax({
        url: "https://re-cart.herokuapp.com/discount",
        type: "POST",
        data: {
            user_ref: userRef
        },
        cache: false,
        success: function () {
            $('.hide_on_submit').hide();
            $('.recart-modal-content .p1').css('margin-top', '200px');
            $('.recart-popup-message').html('<p>' + subscribedMessage + '</p>').append('<button type="button" onclick="recartClosePopup()">OK</button>');

            recartRemoveLinkPopup();
            setCookieSubscribed(525600);
            setTimeout(function () {
                recartClosePopup();
            }, 5000);
        },
        error: function (xhr, error) {
            $(".fbm_submit_button").text("Oops. Please try again!");
        }
    });
}
